{
    "contents" : "\n#**********************************************\n#\n#   Database interaction for FORTS\n#   20.11.2014\n#\n# ********************************************\n\nallexpdates = merge(x = dbOptionsExps(), y = dbFuturesExps(), by.x = \"BaseSec\", by.y = \"SecCode\", all.x = T)\nnames(allexpdates) = c('BaseFut', 'ExpOpt', 'BaseSec', 'ExpFut')\n\npresets = rbind(\n  data.frame(preset='...', ticker='', expdate='', strat='', bound1=0, bound2=0), \n  data.frame(preset='RTSI rise participation', ticker='RTS', expdate='15.06.2015', strat='Long', bound1=0, bound2=0),  \n  data.frame(preset='Currency transform', ticker='Si', expdate='16.06.2015', strat='Transform', bound1=-2, bound2=NA)\n)\n\n\nrates <- rbind(\n  data.frame(currency='RUB', rate=0.17, marginrate=0.03),\n  data.frame(currency='USD', rate=0.035, marginrate=0.0),\n  data.frame(currency='VTB 9.5', rate=0.095, marginrate=0.02)\n  \n)\n\nMainConnection <- function(){\n  \n  require('RODBC')\n  con = odbcConnect('Deriv64')\n  return(con)\n  \n}\n\n\n\n#' Returns Base futures and options expiration dates\n#' \n#' @param connection ODBC Connection object\n#' @export\n\nfortsAllOptionsExps = function(connection = NULL){\n  \n  require('RODBC')\n  if(is.null(connection)) \n    connection = MainConnection()\n  \n  req =  paste(\"SELECT DISTINCT  ExpDate, BaseSec FROM Options ORDER BY BaseSec\", sep=\"\")\n  df  = sqlQuery(connection, req)\n  odbcClose(connection)\n  \n  return(df)\n}\n\n\n\n#' Returns Base assets and Futures expiration dates\n#' \n#' @param connection ODBC Connection object\n#' @export\n\n  fortsAllFuturesExps = function(connection = NULL){\n    \n    require('RODBC')\n    if(is.null(connection)) connection = MainConnection()\n    \n    req =  paste(\"SELECT DISTINCT BaseSec, SecCode, ExpDate FROM Futures ORDER BY BaseSec\", sep=\"\")\n    df = sqlQuery(connection, req)\n    \n    odbcClose(connection)\n    \n    return(df)\n    \n  }\n\n\n\n#' Merged futures, options expiration tables with base sec\n#' \n#' @param connection ODBC Connection object\n#' @export\n\ndbFutOptExps = function(connection = NULL){\n  \n  options(warn = -1)\n  \n  allexpdates =try(merge(x = dbOptionsExps(), y = dbFuturesExps(), by.x = \"BaseSec\", by.y = \"SecCode\", all.x = F), silent=T)\n  names(allexpdates) = c('BaseFut', 'ExpOpt', 'BaseSec', 'ExpFut')\n  \n  return(allexpdates)\n}\n\n\n\n\n#' Get data for multiple derivatives from database\n#' \n#' Ticker and LastTrade for futures; Ticker, TheorPrice and Volatility for options.\n#' @param derivs SecCodes vector\n#' @param types fut/call/put vector\n#' @param connection ODBC Connection object\n#' @export\n\nfortsDerivInfo = function(derivs, types, connection = NULL){\n  \n  require('RODBC')\n  if(is.null(connection)) connection = MainConnection() \n  \n  \n  derivdf = data.frame(seccode =  derivs, type = types, stringsAsFactors = F)\n  \n  # --- Get futures parametres\n  fcodes = derivdf[derivdf$type == 'f', c(\"seccode\")]\n  reqf = paste(fcodes, collapse=\"' OR SecCode='\")\n  req1 =  paste(\"SELECT SecCode, LastPrice FROM Futures WHERE SecCode='\", reqf, \"'\", sep=\"\")\n  res1 = sqlQuery(connection, req1)\n  \n  # --- Get Options parametres\n  ocodes = derivdf[derivdf$type != 'f',c(\"seccode\")]\n  reqo = paste(ocodes, collapse=\"' OR SecCode='\")\n  req2 =  paste(\"SELECT SecCode, tPrice, optVx FROM Options WHERE SecCode='\", reqo, \"'\", sep=\"\")\n  res2 = sqlQuery(connection, req2)\n  \n  odbcClose(connection)\n  \n  return( list(futs=res1, opts=res2) )\n  \n}\n\n\n\n#' Returns table with options a la Quik \n#'\n#' @param b.asset base futures ticker\n#' @param e.date option expiration date in dd.mm.yyyy format (%d.%m.%Y)\n#' @param connection ODBC Connection object\n#' @export\n\nfortsOptionBoard = function(b.asset, e.date, connection = NULL){\n  \n  require('RODBC')\n  if(is.null(connection)) connection = MainConnection() \n  \n  \n  reqputs =  paste(\"SELECT optStrike, tPrice, optVx FROM Options WHERE optType='Put' AND BaseSec='\",b.asset,\"' AND ExpDate='\", e.date, \"'\", sep=\"\")\n  puts.dframe = sqlQuery(connection, reqputs)\n  names(puts.dframe) = c('strike', 'put.theor', 'IV')\n  \n\n  reqcalls =  paste(\"SELECT optStrike, tPrice FROM Options WHERE optType='Call' AND BaseSec='\",b.asset,\"' AND ExpDate='\", e.date, \"'\", sep=\"\")\n  calls.dframe = sqlQuery(connection, reqcalls)\n  names(calls.dframe) = c('strike', 'call.theor')\n  \n  try(odbcClose(connection))\n  \n  return( merge(puts.dframe, calls.dframe, columns=\"strike\") )\n}\n\n\n\n#' Base Asset Price of moex ticker \n#'\n#' @param base.asset MOEX ticker\n#' @param connection ODBC Connection object\n#' @export\n\nfortsBaseAssetPrice = function(base.asset, connection = NULL)\n  {\n  \n  require('RODBC')\n  if(is.null(connection)) connection = MainConnection() \n  \n  req.base.asset =  paste(\"SELECT Value1, Value2 FROM BaseAssets WHERE SecCode='\", base.asset ,\"'\", sep=\"\")\n  \n  ps.base.asset = sqlQuery(connection, req.base.asset)[1,]\n  \n  p.base.asset = ps.base.asset[1, which(ps.base.asset>0 )]\n  \n   odbcClose(connection)\n  \n  return(as.numeric(p.base.asset[1]) )\n\n}\n\n\n\n#' Futures prices of a base asset table\n#'\n#' @param base.asset RTS ticker\n#' @param connection ODBC Connection object\n#' @export\n\nfortsFutsPrices = function(base.asset, connection = NULL)\n  {\n  \n  require('RODBC')\n  if(is.null(connection)) connection = MainConnection() \n  \n  req.str =  paste( \n    \"SELECT SecCode, LastPrice, ExpDate \", \n    \"FROM Futures \",\n    \"WHERE BaseSec='\", base.asset, \"'\",\n    sep = \"\")\n  \n  res = sqlQuery(connection, req.str)\n  \n  odbcClose(connection)\n  \n  return(res)\n  \n}\n\n\n\n#' Price of a single fut by ticker\n#'\n#' @param fut.ticker futures ticker\n#' @param connection ODBC Connection object\n#' @export\n\nfortsFutPrice = function(fut.ticker, connection = NULL)\n  {\n  \n  require('RODBC')\n  if(is.null(connection)) connection = MainConnection() \n  \n  req.str =  paste( \n    \"SELECT LastPrice \", \n    \"FROM Futures \",\n    \"WHERE SecCode='\", fut.ticker, \"'\",\n    sep = \"\")\n  \n  res = as.numeric(sqlQuery(connection, req.str))\n  odbcClose(connection)\n  return(res)\n  \n}\n\n\n\n#' Strikes and vola table\n#'\n#' @param base.fut futures ticker\n#' @param base.asset RTS ticker\n#' @param exp.date options series expiration date\n#' @param connection ODBC Connection object\n#' @export\n\nfortsIvAtStrike = function(base.fut = NULL, base.asset = NULL, exp.date, connection = NULL)\n{\n  require('RODBC')\n  if(is.null(connection)) connection = MainConnection() \n  \n  # Get fut code at expdate and base asset\n  if( is.null(base.fut) ){\n    \n    if(is.null(base.asset)) { dbDisconnect(connection); return()}\n    \n    allexps = dbFutOptExps()\n    base.fut <- subset(allexps, BaseSec==base.asset & ExpOpt==exp.date, BaseFut, drop = T)\n    \n  }\n  \n  req.str =  paste( \n    \"SELECT DISTINCT optStrike, optVx \", \n    \"FROM Options \",\n    \"WHERE BaseSec='\", base.fut, \"' AND \",\n    \"ExpDate='\", exp.date, \"'\",\n     sep = \"\")\n  \n  res = sqlQuery(connection, req.str)\n  odbcClose(connection)\n  \n  return(res)\n}\n\n\n\n#' Strikes, bid, ask, option type table\n#'\n#' @param base.fut futures ticker\n#' @param base.asset RTS ticker\n#' @param exp.date options series expiration date\n#' @param connection ODBC Connection object\n#' @export\n\nfortsStrikesAskBid = function(base.fut, exp.date, connection = NULL)\n{\n  require('RODBC')\n  if(is.null(connection)) connection = MainConnection() \n  \n  req.str =  paste( \n    \"SELECT DISTINCT optStrike, Ask, Bid, optType \", \n    \"FROM Options \",\n    \"WHERE BaseSec='\", base.fut, \"' AND \",\n    \"ExpDate='\", exp.date, \"'\",\n    sep = \"\")\n  \n  res = sqlQuery(connection, req.str)\n  odbcClose(connection)\n  \n  return(res) \n}\n\n# DB.Strikes.Ask.Bid('RIU5', '15.09.2015')\n\n\n# Data: moex, rts, forts ticker, lot size\n\n# symbols = data.frame(\n#   moex  = c(\"RTSI\", \"GAZP\", \"SBER\", \"GOLDS\", \"USD000UTSTOM\", \"EURUSD000TOM\", \"EUR_RUB__TOM\"),\n#   rts   = c(\"RTS\",  \"GAZR\", \"SBRF\", \"GOLD\",  \"Si\",           \"ED\"          , \"Eu\"          ),\n#   short = c(\"RI\",   \"GZ\",   \"SR\",   \"GD\",    \"Si\",           \"ED\"          , \"Eu\"          ),\n#   lot   = c(100,    100,    100,    1,       1000,            1            , 1000          )\n# )\n\n\n\n",
    "created" : 1434393683872.000,
    "dirty" : false,
    "encoding" : "CP1251",
    "folds" : "40|50|51|0|\n60|52|72|2|\n81|43|89|0|\n102|60|126|0|\n137|64|155|0|\n166|3|181|0|\n192|3|209|0|\n220|3|235|0|\n248|1|273|0|\n286|1|301|0|\n",
    "hash" : "2932545071",
    "id" : "14479450",
    "lastKnownWriteTime" : 1434395970,
    "path" : "~/MyR/OptionsPortfilioAnalyser/R/deriv_database.R",
    "project_path" : "R/deriv_database.R",
    "properties" : {
    },
    "relative_order" : 1,
    "source_on_save" : false,
    "type" : "r_source"
}